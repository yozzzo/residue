# Residue 企画・要件・システム詳細（日本語版）

## 0. このドキュメントの目的
- 本作の核となる体験を、企画と実装の両面でブレなく定義する。
- 「要件（何を満たすか）」と「システム詳細（どう動かすか）」を分離して整理する。
- まずはMVPを最短で作り、周回・継承・世界の裏開示を段階的に拡張できる土台を作る。

---

## 1. コンセプト
### 1.1 タイトル案
- `Residue`

### 1.2 コア体験（一言）
- 死と継承を繰り返すほど、別世界の断片がつながり、真実が反転していくコマンド選択型ローグライク。

### 1.3 体験の柱
- `周回継承`: 死亡やクリアを通じて魂の価値が蓄積し、次周で選択肢が増える。
- `世界横断`: 世界固有ジョブを他世界へ持ち込み、会話・イベント差分を発生させる。
- `裏の段階開示`: 初期は違和感、中盤で局所真実、終盤で構造真実が出る。
- `静止画演出`: 高解像度グラではなく、音・SE・フォント・差分演出で世界観を立てる。

---

## 2. ゲーム概要
### 2.1 対象プラットフォーム
- 第一優先: `iOS`
- 同時展開候補: `Android` / `PC`
- 操作: タップ/クリック中心（方向キー不要）

### 2.2 基本画面構成
- 背景静止画（シーン別）
- テキストログ（地の文・会話）
- コマンド選択UI（3-6択）
- ステータス簡易表示（HP/資源/魂価値/現在タグ）

### 2.3 遷移ルール
- フィールド移動はリスト選択式ノード遷移。
- 地理制約あり（例: ダンジョン入口は村からのみ遷移可）。
- ダンジョン内部は「1マス進行+分岐（前/左/右/戻る）」を基本とする。

---

## 3. ループ設計（1周）
1. 世界選択（既存世界または新規世界生成）
2. ジョブ選択（解放済みから選択）
3. 村で準備（会話/情報収集/簡易購入）
4. ダンジョン探索（分岐移動、戦闘、イベント）
5. 中核イベント（ボス/儀式/受け渡し）
6. 周回終了判定（死亡/撤退/クリア）
7. 継承処理（魂価値計算、フラグ更新、解放判定）

---

## 4. 継承設計（重要）
### 4.1 二層継承
- `共通継承（メタ）`
- `世界固有継承（ローカル）`

### 4.2 共通継承
- `魂価値ポイント`: 行動と成果から算出。ジョブ解放や資質解放に使用。
- `記憶フラグ`: 真実開示や隠し会話の鍵。
- `因果タグ`: プレイ傾向を圧縮（例: 慈悲、残酷、探索志向、恐怖耐性）。

### 4.3 世界固有継承
- 世界固有ジョブ（例: 未来世界のサイボーグ）
- 世界固有遺物/呪い/恩寵
- 前周回の痕跡（死体、失敗跡、未回収の伏線）

### 4.4 継承の可変性
- 全部固定で渡さない。毎周「継承候補3択から1つ選ぶ」などで動的余白を残す。

---

## 5. 動的増殖システム
### 5.1 方針
- 完全自動生成ではなく、`行動ログ -> タグ化 -> テンプレ差分生成` で制御する。
- 物語の核は手書き固定。周辺を動的に膨らませる。

### 5.2 パイプライン
1. `ActionLog` 記録
2. `TraitResolver` で因果タグ抽出
3. `ReactionEngine` が会話差分・選択肢差分を追加
4. `ProgressionEngine` が解放/世界変化を判定

### 5.3 差分の階層
- `L1`: フレーバー会話1-2行
- `L2`: 選択肢1つ追加
- `L3`: 特殊イベント開放

### 5.4 分岐爆発の抑制
- イベント本体は共通維持。差分は短尺に限定。
- 各世界の「相性特別ジョブ」は2つまで。
- 重要クロスワールドリンクは各世界1-2本まで。

---

## 6. クロスワールド因果リンク
### 6.1 要件
- 世界生成時に「別世界で取得できる鍵」と「この世界での受け渡し先」を埋め込む。

### 6.2 例
- 中世世界生成時:
  - `requires: item:quantum_circuit`
  - `target: npc:abbot`
  - `trigger: event:mid_chapter`
- 未来世界でボス討伐:
  - `reward: item:quantum_circuit`

### 6.3 成立時効果
- 会話反転
- ルート分岐
- 真実開示
- ジョブ/能力解放

### 6.4 正史と改変シナリオの扱い
- 各ワールドには `正史（大きな歴史）` を1本定義し、これは通常プレイでは不変とする。
- 改変シナリオは `正史の派生レイヤー` として管理し、正史を置き換えない。
- 改変シナリオ突入時も、ワールド基盤設定（地理、主要勢力、時代骨格）は維持する。

---

## 7. 要件定義（何を満たすか）
## 7.1 機能要件（MVP）
- 世界を2種類以上プレイ可能（中世/未来）。
- 各世界に固有ジョブが1つ以上ある。
- 周回終了時に魂価値を計算して蓄積する。
- 魂価値でジョブまたは特性を解放できる。
- 他世界ジョブ持ち込み時、最低1つの差分会話が出る。
- ダンジョンで前/左/右/戻るの分岐移動ができる。
- コマンド選択に任意で制限時間を設定可能。
- 主要イベントに世界の裏を示す段階開示がある。

### 7.2 非機能要件（MVP）
- 1セッション中の画面遷移は体感待ち時間1秒以内を目標。
- データ駆動（JSON/YAML等）で世界/ジョブ/イベントを追加可能。
- 一度生成して承認済みのコンテンツは再利用可能なID付き資産として保存する。
- 同種リクエストでは再生成より検索・再配信を優先し、生成呼び出し回数を抑制する。
- セーブデータ破損時の復旧導線（バックアップorロールバック）を用意。
- iOS実機で安定動作（クラッシュ率低減）。

### 7.3 体験要件
- プレイヤーが「前の死が次に意味を持つ」と感じること。
- 別世界を跨いだ時に「知っているはずの世界が変わる」感覚を提供すること。

---

## 8. システム詳細（どう動かすか）
### 8.1 「システム詳細」とは
- 実装観点の仕様。具体的には以下。
- データモデル（どの情報を保存するか）
- 判定ロジック（何を条件に何を起こすか）
- 実行順序（いつ計算し、いつ反映するか）
- 拡張手順（新世界や新ジョブ追加時の作業）

### 8.2 主要データモデル（最小）
- `World`
  - `world_id`, `tags`, `entry_node`, `seed_flags`
- `Job`
  - `job_id`, `origin_world`, `job_tags`, `unlock_conditions`
- `Node`
  - `node_id`, `world_id`, `node_type`, `edges`, `events`
- `Event`
  - `event_id`, `conditions`, `base_text`, `reaction_slots`, `rewards`
- `PlayerRunState`
  - `hp`, `resources`, `current_world`, `current_node`, `run_tags`
- `MetaState`
  - `soul_points`, `unlocked_jobs`, `memory_flags`, `cross_links`
- `ActionLog`
  - `timestamp`, `action_type`, `target`, `result`

### 8.3 判定ロジック
- `Unlock判定`: 条件式が真なら解放。
- `Reaction判定`: `world_tags + job_tags + trait_tags` に一致した差分を適用。
- `CrossLink判定`: アイテム保有 + 対象イベント到達 + フラグ未消費で成立。
- `Reveal判定`: 周回数・記憶フラグ・特定行動達成で真実段階を進める。

### 8.4 イベント実行順
1. 基本イベント読込
2. 条件一致する差分抽出
3. 会話差分反映
4. 選択肢差分追加
5. 結果適用（報酬/ダメージ/フラグ更新）
6. 追加トリガー確認（解放・連鎖）

### 8.5 コンテンツ追加手順
1. 新世界データ定義
2. ノード接続定義
3. 固定イベント3-5本作成
4. 差分テンプレ登録
5. クロスリンク1本設定
6. テストシナリオ実行

---

## 9. コンテンツ設計ルール
### 9.1 テキスト
- 1選択あたり1-3行を基本。冗長な説明を避ける。
- 固有名詞は少数反復で記憶負荷を抑える。

### 9.2 オーディオ
- BGMは世界ごとに1曲+緊張曲1曲。
- SEは「決定」「失敗」「発見」「異変」の4軸で統一。

### 9.3 ビジュアル
- 背景静止画 + 差分レイヤー（血痕、時間帯、異常化）。
- フォントと字間調整で空気感を作る。

---

## 10. 技術方針（推奨）
### 10.1 エンジン候補
- 採用: `Godot 4`
- 理由: 2D・UI・分岐制御の実装負荷が軽く、iOS/Android/PC展開しやすい。

### 10.2 データ駆動
- ゲーム本体ロジックとコンテンツデータを分離。
- コンテンツは `data/worlds/*.json` などで差し替え可能にする。

---

## 11. MVP範囲（最初に作るもの）
- 世界2種（中世/未来）
- ジョブ4種（共通2 + 世界固有2）
- ダンジョン各世界1本（10-15ノード）
- ボス各1
- クロスリンク2本
- 真実開示2段階
- 周回継承（魂価値、ジョブ解放、記憶フラグ）

---

## 12. 拡張ロードマップ
### フェーズ1（MVP）
- 1周ループ完成、継承成立、最低限の差分反応成立

### フェーズ2（体験強化）
- 因果タグ精度向上
- 制限時間選択の導入
- 会話差分をL2まで拡張

### フェーズ3（長期運用）
- 世界追加を運用で回せるようにする
- 特殊エンディング群
- メタ真相ライン追加

---

## 13. リスクと対策
- `分岐爆発`: タグ差分短尺化 + 相性上限設定で抑制。
- `物語破綻`: 核イベント手書き固定、生成は周辺限定。
- `作業量過多`: 1世界あたり固定イベント数とリンク数に上限。
- `同質化`: 世界ごとに禁則（語彙、音、UI色味）を定義。

---

## 14. 次に詰めるべき詳細（要件確定用）
- 周回終了条件の優先度（死亡/撤退/クリアの重み）
- 魂価値ポイント算出式（例: 深度、討伐、発見、達成）
- 因果タグの初期セット（10-20個）
- 中世/未来それぞれの核イベント3本
- `Residue` という語を作中で初定義するシーン

---

## 15. 用語集
- `周回`: 1回の挑戦単位。
- `継承`: 周回をまたいで残る要素。
- `因果タグ`: 行動傾向を圧縮した内部属性。
- `クロスリンク`: 別世界の条件と報酬が接続された因果線。
- `真実段階`: 世界の裏がどこまで開示されたかの進行度。

---

## 16. 面白さをバランスよく増やす設計
### 16.1 面白さの5軸
- `新規性`: 初見の驚き（新世界、新ジョブ、新真実）。
- `理解性`: 何が起きたかが理解できる（短文、明確な因果）。
- `再現性`: もう一度試せる（再挑戦導線、情報ログ）。
- `変化量`: 周回ごとの違いが体感できる（会話差分、分岐差分）。
- `達成感`: 解放と接続の実感（ジョブ解放、クロスリンク成立）。

### 16.2 1周あたりの体験予算
- 各周回で「新情報」と「既知の再解釈」を両方入れる。
- 目安:
- 新要素1-2件（新会話、新分岐、新報酬）
- 再解釈1件（既存イベントの意味反転）
- 成果1件（ポイント増加、解放進捗）

### 16.3 バランス制御ルール
- 新要素を増やし過ぎない。既存資産への差分追加を優先。
- 高インパクト要素（真相開示、大型分岐）は連続出現を制限する。
- 難易度上昇と物語開示を同期させる。片方だけ先行させない。

### 16.4 周回体験カーブ（固定）
- `1-2周`: 王道ローグライクとして提示し、差分は違和感レベルに抑える。
- `3-6周`: 同一イベントの反応差分（会話1行、報酬小変化、選択肢1つ追加）を増やす。
- `7周以降`: クロスワールド因果を前面化し、意味反転イベントと真実開示を本格化する。

---

## 17. 生成物を使い回すコンテンツ供給モデル
### 17.1 方針
- `Generate Once, Reuse Many` を原則にする。
- 生成AIは「新規作成エンジン」ではなく「不足時の補完エンジン」として使う。

### 17.2 資産単位（再利用可能な最小単位）
- `SceneSnippet`: 会話2-6行 + 条件タグ + 効果。
- `EventVariant`: 既存イベントに差し込む差分選択肢/差分報酬。
- `CrossLinkTemplate`: 別世界条件と受け渡し条件のテンプレ。
- `FlavorPack`: 世界観語彙、SE指定、演出指示のセット。

### 17.3 共有コンテンツプール
- 保存先: `Global Content Pool`（全ユーザー共通）
- キー:
- `content_id`（不変ID）
- `semantic_hash`（意味重複判定）
- `tags`（world/job/trait/tone）
- `quality_score`（品質評価）
- `safety_state`（公開可否）

### 17.4 取り出し順（低コスト優先）
1. ローカルキャッシュ（同一ユーザー端末）
2. 共有プール検索（他ユーザー資産を含む）
3. 近似検索（タグ類似度で再利用）
4. 不足時のみ新規生成
5. 生成後は審査してプール登録

### 17.5 再利用の品質担保
- 登録前に自動検査:
- 文字量、文体、矛盾タグ、禁止語、報酬バランス
- 登録後に評価:
- 採用率、スキップ率、周回継続率への寄与
- 低品質資産は `deprecated` にして配信候補から除外

---

## 18. 遅延・コスト対策（運用仕様）
### 18.1 オンライン時
- 配信は原則プリコンパイル済み資産。
- 生成呼び出しはバックグラウンド実行し、次周以降で反映。

### 18.2 オフライン時
- 直近周回で使う候補資産を先読み。
- 最低限の「安全テンプレセット」を同梱して即応答を保証。

### 18.3 生成予算管理
- 予算単位: `generation_budget_per_day`
- 優先順位:
1. 進行不能を解消する生成
2. 新世界導入時の核イベント生成
3. フレーバー増強生成
- 予算超過時は既存資産の再配列のみで対応

---

## 19. データ設計追補（再利用用）
### 19.1 追加テーブル（概念）
- `content_assets`
  - `content_id`, `type`, `body`, `tags`, `semantic_hash`, `version`, `status`
- `content_usage`
  - `content_id`, `context_tags`, `shown_count`, `pick_rate`, `skip_rate`
- `content_feedback`
  - `content_id`, `rating`, `report_flag`, `updated_at`

### 19.2 運用ループ
1. 利用ログ収集
2. 低評価資産の隔離
3. 良資産の優先配信
4. 欠損領域のみ生成
5. 再度プールへ登録

### 19.3 これで達成できること
- 同一資産を全ユーザーと全周回で再利用できる。
- 生成コストを「新規需要の穴埋め」に限定できる。
- レスポンスをキャッシュ中心に維持できる。

---

## 20. 改変シナリオ解放仕様
### 20.1 基本方針
- 誰か1人が改変シナリオを発見しても、全ユーザーの正史が自動で改変されることはない。
- 改変シナリオは `発見可能コンテンツとして共有` し、突入は各ユーザーのフラグ条件で個別判定する。

### 20.2 解放フロー
1. 改変シナリオの生成・登録（共有プールへ保存）
2. 発見ユーザーに `unlock_flag` を付与
3. 他ユーザーは通常非表示
4. 必要フラグ達成時のみ候補として表示
5. 一度達成したユーザーは `fast_entry_flag` で再突入しやすくする

### 20.3 フラグ設計
- `unlock_flag`: 初回突入の資格（例: 特定アイテム受け渡し成立）
- `fast_entry_flag`: 再突入を簡略化（例: 周回開始時に入口選択肢を追加）
- `world_canon_lock`: 正史進行を維持する保護フラグ

### 20.4 UXルール
- 初回は自然導線（会話の違和感、条件一致で選択肢出現）で入る。
- 2回目以降は回り道を減らして素早く再訪できる。
- 改変ルート中でも、正史未読の重要情報はスキップさせない。

### 20.5 高難度フラグ（隠し解放）
- 一部の改変シナリオは `高難度フラグ` として設計し、発見価値を高める。
- 高難度は全体の10-20%に制限し、主要体験は通常難度で成立させる。
- 高難度フラグ条件の例:
- 複数世界での条件連鎖（A世界で取得 -> B世界で加工 -> C世界で受け渡し）
- 時限選択の連続成功（制限時間付きコマンドを指定回数成功）
- 特定タグの両立（例: `merciful` かつ `reckless` を同一周内で成立）
- 高難度フラグ報酬:
- 真実段階の先行開示
- 特殊ジョブ/特殊会話群
- 近道導線の恒久解放（次回以降の `fast_entry_flag` 強化）
- 失敗時も完全無駄にしない。進捗断片（ヒント、素材、記憶片）を返す。

---

## 21. タイトル方針（Residue）
### 21.1 採用判断
- 本作の中核（死の痕跡、世界横断の異物、消えない因果）と最も整合するため、タイトルは `Residue` を第一候補とする。
- 方向性:
- 世界の嘘が露呈し、後半で不穏さが増す設計なら `Residue` を採用。
- 余韻や叙情を前面化する設計なら `Echoes Trace` を再検討。

### 21.2 企画適合の理由
- `Residue` は「残るもの」を指し、周回継承と因果持ち越しを一語で表現できる。
- 初見では抽象的だが、真実開示後に意味が物語と一致する「タイトル回収」に向く。
- 検索語として固有性が高く、他作品との差別化がしやすい。

### 21.3 注意点
- 明るい印象は弱く、カジュアル層向けの間口は狭くなる。
- UI/ストア文言で「継承ローグライク」「動的分岐」など機能価値を明示して補う。

### 21.4 初定義シーン要件（必須）
- `Residue` の語は序盤で説明しない。一定周回到達後の真実開示で初めて定義する。
- 初定義時は以下の3条件を満たす:
- 世界に残った痕跡（死体、破損、異物）を視覚またはテキストで提示
- NPCが「消したつもりでも残る」趣旨を明言
- プレイヤー行動ログと現象が結び付く演出を入れる

### 21.5 初定義シーン案（実装用）
- 発生条件:
- `loop >= 7`
- `world_truth_stage >= 2`
- `memory_flag: mayor_basement_seen == true`
- 台詞の骨子:
- 「お前は消したと思っている」
- 「この世界は忘れない」
- 「残るんだ。Residueとして」
- 効果:
- `truth_stage +1`
- 改変シナリオ群の入口フラグを解放
- タイトルロゴ演出（ノイズ/欠け）を段階更新

---

## 22. 品質レビュー運用（重点: 音・絵・物語）
### 22.1 基本方針
- 面白さの品質を落とさないため、`実装完了` より `レビュー合格` を優先する。
- サウンドエフェクト、音楽、イラスト、ストーリーは全て必須レビュー対象とする。
- レビュー未承認の資産は本番ビルドに含めない。

### 22.2 レビューゲート
1. `Draft`: ラフ案作成（方向確認）
2. `Internal Review`: 仕様適合、世界観適合、違和感確認
3. `Playtest Review`: 実プレイで体験確認
4. `Final Approval`: 収録可否を最終判定

### 22.3 領域別チェック項目
- `SE`:
- 入力レスポンス遅延を感じないか
- 重複再生や耳障りな帯域がないか
- 世界ごとの音の文法が守られているか
- `BGM`:
- ループ接続の不自然さがないか
- 緊張段階（平常/警戒/異変）で機能しているか
- 会話テキストの可読を邪魔しないか
- `イラスト`:
- 世界タグ（中世/未来など）と矛盾していないか
- 差分レイヤーで意味変化が伝わるか
- UI文字との視認性が成立しているか
- `ストーリー`:
- 正史を壊していないか
- 改変ルートの条件と結果が因果的に妥当か
- `Residue` の概念に回収されるか

### 22.4 不合格条件（差し戻し）
- 世界観と矛盾する資産
- 体験カーブ（1-2 / 3-6 / 7+）を壊す開示順
- 高難度フラグが必須導線を塞ぐ設計
- 同一周回で新規刺激を過剰投入して理解性を下げる実装

### 22.5 運用リズム
- 週次:
- 新規資産のまとめレビュー（音/絵/物語）
- 隔週:
- 通しプレイレビュー（1-2周、3-6周、7+を確認）
- マイルストーン前:
- フリーズレビュー（合格資産のみ収録）

---

## 23. 生成AI制作スタック（採用確定）
### 23.1 採用ツール
- `イラスト本番`: Adobe Firefly
- `SE本番`: ElevenLabs Sound Effects
- `音楽`: Suno（必要に応じて Eleven Music）

### 23.2 使い分けルール
- `探索生成`: 表現探索を高速化するために複数ツール利用可。
- `本番収録`: 上記採用ツールで生成し、レビュー合格した資産のみ収録。
- `差し替え容易性`: すべての素材に `asset_id` と生成元情報を保持する。

### 23.3 権利・運用ルール
- 本番収録前に利用規約と商用条件の確認ログを残す。
- 素材ごとに `tool_name`, `plan`, `generated_at`, `prompt_hash` を記録する。
- 規約変更時に再監査できるよう、採用資産の台帳を維持する。

### 23.4 レビューゲート連携
- `Draft`: プロンプト方向性のみ確認
- `Internal Review`: 世界観整合と法務チェック同時実施
- `Playtest Review`: ゲーム中での没入感と反復耐性を確認
- `Final Approval`: 音・絵・物語の総合承認後に収録

---

## 24. アセット配信方針（通信量対策）
- イラスト等の重い資産は `asset_id + tags + version + hash` で管理する。
- クライアントは資産本体を都度API取得せず、まず `manifest` 差分を取得する。
- 初回は通信種別を判定し、Wi-Fi時のみ高優先資産を先読みする。
- 平常時はローカルキャッシュ優先で、再ダウンロードを回避する。
- 詳細仕様は `/Users/yozo/dev/residue/docs/ASSET_MANIFEST_AND_CACHE_SPEC_ja.md` を正とする。

---

## 25. 開発意思決定リファレンス
- 推奨案と選択肢の整理は `/Users/yozo/dev/residue/docs/DEVELOPMENT_OPTIONS_AND_RECOMMENDATIONS_ja.md` を参照。
- 本書の未確定項目を判断する際は、同ドキュメントの「現時点の推奨セット」を初期値として使う。
- 実装タスク分解は `/Users/yozo/dev/residue/docs/IMPLEMENTATION_TASK_BREAKDOWN_ja.md` を参照。
- セットアップ手順は `/Users/yozo/dev/residue/docs/SETUP_AND_RUN_ja.md` を参照。
